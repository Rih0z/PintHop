----
# ドキュメント情報
プロジェクト: PintHop
ファイル名: incident-response.md
ファイルパス: Document/jp/incident-response.md
作成者: Koki Riho (https://github.com/Rih0z)
作成日: 2025-04-20

# 更新履歴
- 2025-04-20 Koki Riho 初版作成

# 説明
PintHopアプリケーションで発生する可能性のあるインシデントへの対応計画を定義するドキュメント。インシデントの分類、対応手順、連絡体制、復旧手順、および事後分析のプロセスを詳細に説明します。
----

# PintHop インシデント対応計画

## 1. 概要

本ドキュメントはPintHopアプリケーションのインシデント対応計画を定義するものです。PintHopは「次の一杯を見つける」個人体験と「自然に友達とつながる」社会体験を同等に重視した、クラフトビール体験向上プラットフォームであり、1人での効率的運用を前提としています。本計画では、インシデント発生時の迅速かつ効果的な対応、影響の最小化、サービスの早期復旧、および再発防止のための手順を定めます。

### 1.1 目的

- インシデント発生時の明確な対応手順の提供
- インシデントの影響範囲の最小化
- ユーザーデータのプライバシーと完全性の保護
- サービスの早期復旧と利用可能性の維持
- インシデントからの学習と再発防止策の実施
- 1人運用環境での効率的なインシデント管理の実現

### 1.2 適用範囲

本計画は以下のPintHopシステムコンポーネントに適用されます：

- バックエンドAPI（Node.js + Express、rihobeer.comでホスト）
- フロントエンドアプリケーション（React、Netlifyでホスト）
- データベース（MongoDB Atlas）
- 認証システム（JWT）
- リアルタイム通信（WebSocket）
- 外部サービス連携（Mapbox、レビューサイトデータ）
- タップリスト画像およびユーザーアップロードコンテンツ

### 1.3 インシデント対応チーム（1人運用向け）

PintHopは1人運用を前提としているため、以下のように効率的なインシデント対応を行います：

- **主担当**: Koki Riho (アプリケーション開発・運用担当)
- **バックアップ連絡先**: 必要に応じて技術協力者を指定
- **外部サポート**:
  - MongoDB Atlas サポート
  - Netlify サポート
  - ドメインレジストラサポート
  - AWS/クラウドサービスサポート

## 2. インシデント分類と対応レベル

### 2.1 インシデント分類

PintHopにおけるインシデントは影響の大きさから以下の3段階に分類します：

#### 2.1.1 低影響インシデント

ユーザー体験に最小限の影響を与えるが、基本機能は維持される問題。

- **例**:
  - 一時的なパフォーマンス低下
  - 単発的なエラー報告
  - マイナーな機能不具合
  - 一部の非重要機能の不具合
  - UI表示の軽微な問題
  - 通知の遅延

- **影響範囲**:
  - 一部のユーザーのみに影響
  - コア機能への影響なし
  - データ損失なし

- **目標復旧時間**: 24時間以内

#### 2.1.2 中影響インシデント

複数のユーザーに影響を与え、一部の重要機能が利用できなくなる問題。

- **例**:
  - サービス部分的停止
  - ユーザーデータ一部アクセス不能
  - APIの一部エンドポイント障害
  - 繰り返し発生するエラー
  - ブルワリーデータの表示問題
  - 地図機能の部分的障害
  - チェックイン機能の障害
  - 画像アップロード機能の障害

- **影響範囲**:
  - 複数ユーザーに影響
  - 一部の重要機能に影響
  - 限定的なデータアクセス問題

- **目標復旧時間**: 8時間以内

#### 2.1.3 高影響インシデント

サービス全体に重大な影響を与え、多数のユーザーが影響を受ける問題。

- **例**:
  - 完全なサービス停止
  - データベース接続の完全喪失
  - 認証システムの完全障害
  - データ損失の可能性
  - セキュリティ侵害の可能性
  - WebSocketサーバーの完全障害
  - プライバシー情報の漏洩リスク

- **影響範囲**:
  - 全ユーザーまたは大多数のユーザーに影響
  - コア機能の完全停止
  - データの整合性への懸念

- **目標復旧時間**: 4時間以内

### 2.2 セキュリティインシデント特別分類

セキュリティに関わるインシデントは特別な扱いが必要です：

- **低セキュリティリスク**:
  - 非機密情報への未認可アクセス試行
  - 軽微なクロスサイトスクリプティング(XSS)の可能性
  - レート制限回避の試み

- **中セキュリティリスク**:
  - 一部ユーザーの認証情報の漏洩の可能性
  - 特定のAPIエンドポイントでの入力検証バイパス
  - サービス拒否(DoS)攻撃の試み

- **高セキュリティリスク**:
  - ユーザーの位置情報や個人データの大規模漏洩
  - データベースへの不正アクセス
  - JWT認証システムの脆弱性悪用
  - 分散型サービス拒否(DDoS)攻撃
  - コードインジェクション攻撃の発生

## 3. 対応手順と連絡体制

### 3.1 低影響インシデント対応

1. **検出と初期評価（30分以内）**
   - ログ監視システムからのアラート確認
   - エラーの性質と発生パターンの特定
   - 影響を受けるコンポーネントの特定
   - 潜在的な原因の初期評価

2. **調査（1時間以内）**
   - 関連するログの詳細分析
   - エラー発生条件の再現テスト
   - コード変更履歴の確認（最近のデプロイとの関連）
   - 依存サービスの状態確認

3. **解決と検証（4時間以内）**
   - 必要に応じたパッチ適用またはコード修正
   - 設定変更または再起動の実施
   - 修正の検証テスト実施
   - 正常動作の確認

4. **文書化（24時間以内）**
   - インシデント詳細の記録
   - 解決策と実施した対策の文書化
   - 必要に応じたコードレビューの実施

### 3.2 中影響インシデント対応

1. **検出と初期評価（15分以内）**
   - 異常検出と初期評価の実施
   - インシデントの詳細記録開始
   - 影響範囲の特定と初期分類
   - 基本的な診断手順の実行

2. **通知とエスカレーション（30分以内）**
   - ステータスページの更新（問題調査中のメッセージ）
   - 外部サービスプロバイダーへの通知（必要な場合）
   - バックアップ技術者への連絡（必要な場合）

3. **封じ込めと対応（2時間以内）**
   - 影響を受けるコンポーネントの隔離
   - バックアップ確認と復元準備
   - 応急処置の実施
   - 一時的な回避策の実装

4. **復旧と検証（4時間以内）**
   - 根本原因の特定と修正
   - サービスの復旧手順の実行
   - 復旧後の機能検証テスト
   - データ整合性の確認

5. **コミュニケーションと報告（8時間以内）**
   - ステータスページの更新（問題解決のメッセージ）
   - 影響を受けたユーザーへの通知（必要な場合）
   - インシデント報告書の作成

### 3.3 高影響インシデント対応

1. **検出と初期評価（5分以内）**
   - 重大アラート確認と即時対応開始
   - インシデントの詳細記録と証拠保全
   - 初期影響範囲の評価
   - インシデント対応モードへの移行

2. **即時対応（15分以内）**
   - ステータスページの更新（サービス障害の告知）
   - 外部サービスプロバイダーへの緊急連絡
   - バックアップ技術者への緊急連絡
   - 技術サポートへの連絡（必要に応じて）

3. **封じ込めと保護対策（30分以内）**
   - 被害拡大防止のための緊急措置実施
   - 必要に応じたサービスの一時停止
   - アクセス制限の緊急適用
   - バックアップからの復元準備

4. **根本原因の特定と解決（2時間以内）**
   - 詳細な原因調査の実施
   - 修復策の開発と検証
   - 段階的復旧計画の策定
   - 外部リソースからの支援要請（必要に応じて）

5. **復旧とサービス再開（4時間以内）**
   - 段階的復旧手順の実行
   - サービス機能の優先順位付けによる復旧
   - 各段階での検証テスト実施
   - データ整合性と安全性の確認

6. **コミュニケーションと報告（24時間以内）**
   - ステータスページの更新（復旧完了の告知）
   - 詳細なインシデント報告書の作成
   - ユーザーへの影響説明と対応報告
   - 再発防止策の公表（適切な場合）

### 3.4 セキュリティインシデント特別対応

セキュリティインシデントが疑われる場合は、以下の追加手順を実施します：

1. **即時対応**
   - 影響を受けたシステムの隔離
   - 脆弱なエンドポイントの一時的無効化
   - 不正アクセスの証拠保全

2. **ユーザーデータ保護措置**
   - 影響を受けたアカウントのロック
   - 必要に応じたパスワードリセット強制
   - 不正アクセスの痕跡の調査

3. **侵入経路の特定と対策**
   - 侵入方法の詳細分析
   - 悪用された脆弱性の特定
   - 同様の脆弱性の有無を確認

4. **再発防止策の実施**
   - パッチまたはコード修正の適用
   - セキュリティ設定の強化
   - 追加のセキュリティ対策の実装

5. **報告と透明性確保**
   - 適切な場合のユーザーへの通知
   - 影響範囲と対応措置の説明
   - 実施した改善策の報告

### 3.5 連絡体制とエスカレーションパス

1. **基本連絡体制**
   - 主担当: Koki Riho
     - メール: [メールアドレス]
     - 電話: [電話番号]
   - バックアップ連絡先: [バックアップ担当者名]
     - メール: [メールアドレス]
     - 電話: [電話番号]

2. **外部サービスサポート連絡先**
   - MongoDB Atlas: support@mongodb.com / サポートポータル
   - Netlify: support@netlify.com / サポートポータル
   - AWS: サポートポータル / 緊急サポート電話番号
   - ドメインレジストラ: [連絡先情報]

3. **エスカレーションパス**
   - レベル1: 主担当者による対応
   - レベル2: バックアップ担当者を含めた対応
   - レベル3: 外部技術サポートの要請

## 4. 復旧手順

### 4.1 サービス別復旧手順

#### 4.1.1 バックエンドAPI復旧

1. **基本診断**
   ```bash
   # サーバー接続確認
   ssh username@rihobeer.com
   
   # Node.jsプロセス確認
   pm2 list
   pm2 logs pinthop-api
   
   # サーバーリソース確認
   htop
   df -h
   ```

2. **サービス再起動**
   ```bash
   # アプリケーション再起動
   pm2 restart pinthop-api
   
   # 完全再起動が必要な場合
   pm2 stop pinthop-api
   pm2 delete pinthop-api
   cd /var/www/pinthop
   pm2 start app.js --name "pinthop-api"
   ```

3. **データベース接続復旧**
   ```bash
   # MongoDB接続確認
   mongo --eval "db.adminCommand('ping')"
   
   # 接続文字列確認
   nano /var/www/pinthop/.env
   ```

4. **ログ分析**
   ```bash
   # エラーログ確認
   tail -n 100 /var/log/pinthop/api.log | grep -i "error"
   
   # Nginx接続確認
   tail -n 100 /var/log/nginx/access.log
   tail -n 100 /var/log/nginx/error.log
   ```

5. **Nginx復旧**
   ```bash
   # Nginx設定確認
   sudo nginx -t
   
   # Nginxサービス再起動
   sudo systemctl restart nginx
   ```

#### 4.1.2 フロントエンド復旧

1. **Netlifyデプロイ状態確認**
   - Netlifyダッシュボードにアクセス
   - デプロイログの確認
   - ビルドエラーの特定

2. **手動再デプロイ**
   - Netlifyダッシュボードから手動トリガー
   - または以下のコマンドでCLIから実行:
   ```bash
   netlify deploy --prod
   ```

3. **キャッシュクリア**
   - Netlifyダッシュボードからキャッシュ無効化
   - CDNキャッシュのパージ

4. **DNSとSSL確認**
   - DNS設定の確認
   - SSL証明書の有効期限確認

#### 4.1.3 データベース復旧

1. **MongoDB Atlas状態確認**
   - Atlasダッシュボードにアクセス
   - クラスターの状態確認
   - 最新のバックアップポイント確認

2. **接続問題のトラブルシューティング**
   - 接続文字列の検証
   - ネットワークアクセス設定の確認
   - IP許可リストの確認

3. **データ復元手順**
   ```bash
   # 最新のバックアップからの復元（Atlas UI）または
   mongorestore --uri="mongodb+srv://username:password@cluster.mongodb.net" --db=pinthop /path/to/backup
   ```

4. **データ整合性確認**
   ```javascript
   // 各コレクションのドキュメント数確認
   db.users.countDocuments()
   db.breweries.countDocuments()
   db.checkins.countDocuments()
   ```

#### 4.1.4 認証システム復旧

1. **JWT設定確認**
   ```bash
   # .env設定確認
   grep JWT_ /var/www/pinthop/.env
   ```

2. **ユーザー認証リセット**
   ```javascript
   // 全ユーザーの強制ログアウト（必要な場合）
   db.users.updateMany({}, { $set: { refreshTokens: [] } })
   ```

3. **認証エンドポイントテスト**
   ```bash
   # APIエンドポイントテスト
   curl -X POST https://api.pinthop.com/api/v1/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"testpassword"}'
   ```

### 4.2 データバックアップと復元

1. **自動バックアップ確認**
   ```bash
   # バックアップスクリプト実行確認
   cat /var/log/pinthop/backups.log
   ```

2. **MongoDB Atlasバックアップアクセス**
   - Atlasダッシュボード > クラスター > バックアップ
   - 最新のバックアップポイントを確認

3. **手動バックアップ実行**
   ```bash
   # 緊急バックアップ実行
   /var/www/pinthop/scripts/backup.sh
   ```

4. **データ復元手順**
   ```bash
   # 環境変数のリストア
   cp /var/backups/pinthop/.env_[TIMESTAMP] /var/www/pinthop/.env
   
   # データベース復元（Atlas UIまたはmongorestore）
   ```

5. **ファイルバックアップ復元**
   ```bash
   # ユーザーアップロードの復元（必要に応じて）
   cp -r /var/backups/pinthop/uploads_[TIMESTAMP]/* /var/www/pinthop/uploads/
   ```

### 4.3 サービス優先順位復旧計画

インシデント発生時のサービス復旧優先順位：

1. **最優先サービス（P0）**
   - 認証システム（ログイン/トークン更新）
   - コアAPI（ブルワリーデータ、チェックイン）
   - データベース接続
   - 基本的なフロントエンド表示

2. **高優先度サービス（P1）**
   - 地図表示機能
   - リアルタイム更新（WebSocket）
   - 友達関連機能
   - タップリスト表示

3. **標準優先度サービス（P2）**
   - 画像アップロード
   - 通知機能
   - 検索・フィルタリング
   - ユーザープロフィール

4. **低優先度サービス（P3）**
   - バッジシステム
   - 統計情報表示
   - イベント情報
   - 外部連携機能

## 5. 事後分析と再発防止

### 5.1 インシデント事後レビュー（ポストモーテム）

各インシデント解決後、以下の手順で事後分析を実施します：

1. **事実確認**
   - 発生日時と継続時間
   - 影響を受けたシステムコンポーネント
   - 影響を受けたユーザー数/比率
   - 発見方法と初期対応時間
   - 実施した対応措置とその効果

2. **根本原因分析**
   - 直接的な障害原因の特定
   - 根本的な要因の特定（技術的・プロセス的両面）
   - 潜在的な関連問題の検討
   - 発生に至るイベント系列の記録

3. **対応プロセスの振り返り**
   - 検出から解決までのタイムライン
   - 対応の有効性評価
   - コミュニケーションの適切さ
   - 文書化の十分性

4. **教訓と改善点の特定**
   - 技術的改善点
   - プロセス改善点
   - ドキュメント改善点
   - モニタリング強化点

### 5.2 再発防止策の策定

事後分析に基づき、以下のカテゴリで再発防止策を実施します：

1. **技術的改善**
   - コード修正・パッチ適用
   - アーキテクチャ変更
   - 冗長化・バックアップ強化
   - 自動復旧メカニズムの実装

2. **モニタリング強化**
   - 新規アラートの設定
   - ログ収集の拡充
   - 異常検知の感度調整
   - ヘルスチェックの追加

3. **プロセス改善**
   - インシデント対応手順の更新
   - チェックリストの拡充
   - 定期的な訓練の実施
   - 外部サポートの事前手配

4. **ドキュメント更新**
   - 復旧手順の詳細化
   - 既知の問題と対処法の記録
   - トラブルシューティングガイドの拡充
   - 環境設定ドキュメントの更新

### 5.3 改善サイクルの確立

1. **四半期レビュー**
   - 過去3ヶ月のインシデント傾向分析
   - 再発防止策の有効性評価
   - リスク評価の見直し
   - 計画の更新と調整

2. **予防的対策**
   - 定期的な脆弱性スキャン
   - ペネトレーションテスト（適切な規模で）
   - 負荷テストの定期実施
   - 依存コンポーネントの更新確認

3. **知識ベースの構築**
   - 過去のインシデントデータベース化
   - 解決策と回避策のライブラリ作成
   - トラブルシューティングガイドの維持
   - 効果的な対応事例の記録

## 6. インシデント報告書テンプレート

### 6.1 報告書基本情報

```
# PintHop インシデント報告書

## 基本情報
- インシデントID: INC-[日付]-[連番]
- 日時: [検出日時] ～ [解決日時]
- 影響レベル: [低/中/高]
- 影響範囲: [影響を受けたコンポーネント/機能]
- 影響ユーザー: [概算数/比率]
- 対応者: [担当者名]

## 概要
[インシデントの簡潔な説明]

## 詳細タイムライン
- [時刻] [イベント/対応内容]
- [時刻] [イベント/対応内容]
- ...

## 原因分析
[直接的原因と根本的原因の説明]

## 対応措置
[実施した対応策と結果]

## 改善・再発防止策
- [短期的対策]
- [長期的対策]

## 学習と教訓
[インシデントから学んだ教訓や知見]

## 添付資料
- [関連ログ、スクリーンショット等]
```

### 6.2 レポート作成手順

1. インシデント収束後24時間以内に初版を作成
2. 関連するエビデンス（ログ、スクリーンショット等）を添付
3. 根本原因が判明した時点で更新
4. 再発防止策策定後に最終版を作成
5. `/var/www/pinthop/docs/incidents/` ディレクトリに保存

### 6.3 トラッキングと傾向分析

- インシデント一覧表の維持
- 四半期ごとの傾向分析実施
- 再発パターンの特定
- 共通の根本原因の特定

## 7. リソースと参考情報

### 7.1 内部リソース

- サーバー設定ドキュメント: `/var/www/pinthop/docs/server-config.md`
- バックアップ手順: `/var/www/pinthop/docs/backup-procedures.md`
- モニタリング設定: `/var/www/pinthop/docs/monitoring-setup.md`
- リカバリスクリプト: `/var/www/pinthop/scripts/recovery/`

### 7.2 外部リソース

- MongoDB Atlas ドキュメント: https://docs.atlas.mongodb.com/
- Netlify サポート: https://docs.netlify.com/
- Express.js トラブルシューティング: https://expressjs.com/en/advanced/debugging.html
- Node.js デバッグガイド: https://nodejs.org/en/docs/guides/debugging-getting-started/

### 7.3 チェックリストとテンプレート

- インシデント初期対応チェックリスト: `/var/www/pinthop/docs/incident-first-response.md`
- サービス復旧チェックリスト: `/var/www/pinthop/docs/service-recovery.md`
- コミュニケーションテンプレート: `/var/www/pinthop/docs/communication-templates.md`

## 8. 計画の維持と更新

本インシデント対応計画は少なくとも四半期に一度、または以下のイベント発生時に見直しと更新を行います：

1. 重大インシデント発生後
2. システムアーキテクチャの大幅な変更時
3. 新機能のリリース時
4. 新たな脅威や脆弱性の発見時
5. 外部依存サービスの変更時

更新履歴は本ドキュメントのヘッダーに記録し、変更内容を明記します。

## 付録A: 緊急連絡先リスト

| 役割 | 名前 | メール | 電話 | 代替連絡先 |
|-----|-----|-------|-----|----------|
| 主担当 | Koki Riho | [メール] | [電話] | [代替] |
| バックアップ | [名前] | [メール] | [電話] | [代替] |
| MongoDB Atlas | サポート | support@mongodb.com | [サポート番号] | サポートポータル |
| Netlify | サポート | support@netlify.com | [サポート番号] | サポートポータル |
| ドメインレジストラ | [担当] | [メール] | [電話] | [代替] |
| クラウドプロバイダ | [担当] | [メール] | [電話] | [代替] |

## 付録B: サービス依存関係マップ

```
PintHopアプリケーション
├── フロントエンド (Netlify)
│   ├── React アプリケーション
│   ├── Mapbox API
│   └── ブラウザWebSocket接続
│
├── バックエンド (rihobeer.com)
│   ├── Express.js API
│   ├── WebSocketサーバー
│   ├── JWT認証サービス
│   └── ファイルストレージ
│
└── データベース
    ├── MongoDB Atlas クラスター
    ├── ブルワリーデータセット
    └── ユーザーデータ
```

## 付録C: 復旧時間目標 (RTO) と復旧ポイント目標 (RPO)

| サービス | RTO | RPO | 備考 |
|---------|-----|-----|------|
| 認証システム | 1時間 | 0 | ユーザー認証は最優先 |
| コアAPI | 2時間 | 0 | ブルワリーデータ・チェックイン |
| WebSocket | 4時間 | 最小 | リアルタイム更新 |
| 画像ストレージ | 8時間 | 24時間 | タップリスト画像など |
| バッジシステム | 24時間 | 24時間 | 非クリティカル機能 |
